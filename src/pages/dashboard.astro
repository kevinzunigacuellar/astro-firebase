---
import Layout from "../layouts/Layout.astro";
import { auth, firestore } from "../lib/firebase/server";
import BirthdayList from "../components/BirthdayList";
import type { BirthdayType } from "../lib/types";
import SignoutButton from "../components/SignoutButton";

/* Get session cookie */
const sessionCookie = Astro.cookies.get("session").value;
if (!sessionCookie) {
  return Astro.redirect("/login");
}

/* Verify session cookie and get user */
let user;
try {
  const decodedClaims = await auth.verifySessionCookie(sessionCookie, true);
  user = await auth.getUser(decodedClaims.uid);
} catch (error) {
  return Astro.redirect("/login");
}

/* get birthdates from firestore */
const querySnashot = await firestore
  .collection("birthdays")
  .where("authorId", "==", user.uid)
  .get();

/* fetch data from firestore */
const birthdays = querySnashot.docs.map((doc) => doc.data()) as BirthdayType[];
---

<Layout title="Dashboard">
  <nav class="bg-zinc-950 border-b border-zinc-800">
    <div class="p-4 flex justify-between items-center max-w-4xl mx-auto">
    <span class="text-lg font-semibold text-zinc-100">Birthday Tracker</span>
    <SignoutButton client:idle />
  </div>
  </nav>
  <main class="w-full grow flex flex-col items-center justify-center gap-2 p-4">
    <h1 class="text-3xl text-zinc-300 font-semibold">Incoming Birthdays ğŸ</h1>
    <BirthdayList birthdays={birthdays} client:idle />
  </main>
</Layout>
